<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart PrtScr - Save</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      -webkit-app-region: drag;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      width: 500px;
      -webkit-app-region: no-drag;
    }

    h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      border-color: #667eea;
    }

    .extension {
      color: #666;
      font-size: 14px;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #333;
    }

    .btn-cancel:hover {
      background: #d0d0d0;
    }

    .btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .hint {
      color: #888;
      font-size: 12px;
      margin-top: 10px;
    }

    .preview {
      margin-bottom: 15px;
      text-align: center;
    }

    .preview canvas {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* Section collapsible */
    .section {
      margin-top: 15px;
      border-top: 1px solid #e0e0e0;
      padding-top: 10px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      padding: 8px 0;
    }

    .section-header:hover h3 {
      color: #667eea;
    }

    .section h3 {
      font-size: 14px;
      margin: 0;
      color: #555;
      transition: color 0.2s;
    }

    .collapse-icon {
      font-size: 10px;
      color: #888;
      transition: transform 0.3s;
    }

    .section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .section-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      max-height: 500px;
    }

    .section.collapsed .section-content {
      max-height: 0;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 10px 0;
    }

    .option-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .option-row label {
      font-size: 12px;
      color: #666;
    }

    .option-row select, .option-row input[type="number"] {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      font-size: 12px;
    }

    .option-row input[type="number"] {
      width: 70px;
    }

    .option-row.full-width {
      grid-column: 1 / -1;
    }

    .option-row input[type="checkbox"] {
      margin-right: 5px;
    }

    .options-disabled {
      opacity: 0;
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
    }

    .style-buttons {
      display: flex;
      gap: 8px;
    }

    .style-checkbox {
      display: flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-size: 12px;
    }

    .style-checkbox:hover {
      background: #f0f0f0;
    }

    .style-checkbox input {
      margin: 0;
    }

    .destination-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding: 8px 10px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 12px;
    }

    .destination-label {
      color: #666;
      white-space: nowrap;
    }

    .destination-path {
      flex: 1;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    .destination-path:hover {
      color: #667eea;
    }

    .btn-folder {
      padding: 4px 8px;
      border: none;
      background: #667eea;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-folder:hover {
      background: #5a6fd6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="preview">
      <canvas id="preview-canvas"></canvas>
    </div>
    <h2>Nom de la capture</h2>
    <div class="input-group">
      <input type="text" id="filename" autofocus>
      <span class="extension">.jpg</span>
    </div>
    <p class="hint">Laissez vide pour utiliser le nom par defaut</p>

    <div class="destination-row">
      <span class="destination-label">Dossier :</span>
      <span class="destination-path" id="destinationPath" onclick="changeDestination()" title="Cliquez pour changer">Chargement...</span>
      <button class="btn-folder" onclick="changeDestination()" title="Changer le dossier">üìÅ</button>
    </div>

    <div class="section collapsed" id="sectionTimestamp">
      <div class="section-header" onclick="toggleSection('sectionTimestamp')">
        <h3>Options d'horodatage</h3>
        <span class="collapse-icon">‚ñº</span>
      </div>
      <div class="section-content">
        <div class="option-row full-width" style="padding: 10px 0 5px 0; flex-direction: row; align-items: center;">
          <input type="checkbox" id="timestampEnabled" onchange="updatePreview()">
          <label for="timestampEnabled" style="cursor: pointer;"><strong>Activer l'horodatage</strong></label>
        </div>

        <div id="timestampOptionsContainer" class="options-grid">
          <div class="option-row">
            <label>Type d'affichage</label>
            <select id="timestampType" onchange="updatePreview()">
              <option value="banner-dark">Bandeau sombre</option>
              <option value="banner-light">Bandeau clair</option>
              <option value="overlay">Par-dessus l'image</option>
            </select>
          </div>

          <div class="option-row">
            <label>Position</label>
            <select id="timestampPosition" onchange="updatePreview()">
              <option value="bottom">Bas</option>
              <option value="top">Haut</option>
            </select>
          </div>

          <div class="option-row">
            <label>Taille du texte (px)</label>
            <input type="number" id="timestampFontSize" min="8" max="72" value="14" onchange="updatePreview()" oninput="updatePreview()">
          </div>

          <div class="option-row">
            <label>Couleur du texte</label>
            <select id="timestampTextColor" onchange="updatePreview()">
              <option value="white">Blanc</option>
              <option value="black">Noir</option>
              <option value="gray">Gris</option>
              <option value="red">Rouge</option>
              <option value="green">Vert</option>
              <option value="blue">Bleu</option>
              <option value="yellow">Jaune</option>
              <option value="cyan">Cyan</option>
              <option value="magenta">Magenta</option>
            </select>
          </div>

          <div class="option-row">
            <label>Alignement du texte</label>
            <select id="timestampTextAlign" onchange="updatePreview()">
              <option value="left">Gauche</option>
              <option value="center">Centr√©</option>
              <option value="right">Droite</option>
            </select>
          </div>

          <div class="option-row">
            <label>Style du texte</label>
            <div class="style-buttons">
              <label class="style-checkbox"><input type="checkbox" id="timestampBold" onchange="updatePreview()"> <b>G</b></label>
              <label class="style-checkbox"><input type="checkbox" id="timestampItalic" onchange="updatePreview()"> <i>I</i></label>
              <label class="style-checkbox"><input type="checkbox" id="timestampUnderline" onchange="updatePreview()"> <u>S</u></label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button class="btn-cancel" onclick="cancel()">Annuler</button>
      <button class="btn-save" onclick="save()">Enregistrer</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const input = document.getElementById('filename');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');
    let originalImage = null;

    // Couleurs
    const textColors = {
      white: '#ffffff',
      black: '#000000',
      gray: '#808080',
      red: '#ff0000',
      green: '#00ff00',
      blue: '#0000ff',
      yellow: '#ffff00',
      cyan: '#00ffff',
      magenta: '#ff00ff'
    };


    // Toggle section collapse
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');

      // Redimensionner la fen√™tre
      setTimeout(() => {
        ipcRenderer.send('resize-dialog');
      }, 350);
    }

    // Mettre √† jour l'√©tat des options
    function updateOptionsState() {
      const enabled = document.getElementById('timestampEnabled').checked;
      const container = document.getElementById('timestampOptionsContainer');
      if (enabled) {
        container.classList.remove('options-disabled');
      } else {
        container.classList.add('options-disabled');
      }
    }

    // Mettre √† jour l'aper√ßu
    function updatePreview() {
      updateOptionsState();

      if (!originalImage) return;

      const options = getCurrentOptions();
      const img = originalImage;
      const fontSize = options.fontSize || 14;
      const bannerHeight = Math.max(24, fontSize + 10);

      // Calculer les dimensions du canvas
      const isOverlay = options.type === 'overlay';
      let canvasHeight = img.height;
      if (options.enabled && !isOverlay) {
        canvasHeight = img.height + bannerHeight;
      }

      canvas.width = img.width;
      canvas.height = canvasHeight;

      // Dessiner l'image
      if (options.enabled && !isOverlay && options.position === 'top') {
        ctx.drawImage(img, 0, bannerHeight);
      } else {
        ctx.drawImage(img, 0, 0);
      }

      // Dessiner l'horodatage si activ√©
      if (options.enabled) {
        const now = new Date();
        const timestamp = now.toLocaleString('fr-FR');
        const textColor = textColors[options.textColor] || textColors.white;
        const isOverlay = options.type === 'overlay';
        const bannerColor = options.type === 'banner-light' ? '#f5f5f5' : '#333333';

        // Construire la police
        let fontStyle = '';
        if (options.italic) fontStyle += 'italic ';
        if (options.bold) fontStyle += 'bold ';
        fontStyle += fontSize + 'px Arial';

        ctx.font = fontStyle;
        ctx.fillStyle = textColor;

        // Calculer la position X selon l'alignement
        let textX;
        if (options.textAlign === 'left') {
          ctx.textAlign = 'left';
          textX = 10;
        } else if (options.textAlign === 'right') {
          ctx.textAlign = 'right';
          textX = img.width - 10;
        } else {
          ctx.textAlign = 'center';
          textX = img.width / 2;
        }

        // Calculer la position Y
        let bannerY, textY;
        if (!isOverlay) {
          if (options.position === 'top') {
            bannerY = 0;
            textY = bannerHeight / 2 + fontSize / 3;
          } else {
            bannerY = img.height;
            textY = img.height + bannerHeight / 2 + fontSize / 3;
          }
          // Dessiner le bandeau
          ctx.fillStyle = bannerColor;
          ctx.fillRect(0, bannerY, img.width, bannerHeight);
          ctx.fillStyle = textColor;
        } else {
          // Overlay
          if (options.position === 'top') {
            textY = bannerHeight / 2 + fontSize / 3;
          } else {
            textY = img.height - bannerHeight / 2 + fontSize / 3;
          }
        }

        // Dessiner le texte
        ctx.fillText(timestamp, textX, textY);

        // Soulignement
        if (options.underline) {
          const textWidth = ctx.measureText(timestamp).width;
          let underlineX;
          if (options.textAlign === 'left') {
            underlineX = 10;
          } else if (options.textAlign === 'right') {
            underlineX = img.width - 10 - textWidth;
          } else {
            underlineX = (img.width - textWidth) / 2;
          }
          ctx.beginPath();
          ctx.strokeStyle = textColor;
          ctx.lineWidth = Math.max(1, fontSize / 10);
          ctx.moveTo(underlineX, textY + 3);
          ctx.lineTo(underlineX + textWidth, textY + 3);
          ctx.stroke();
        }
      }
    }

    // Charger les options d'horodatage
    function loadTimestampOptions(options) {
      document.getElementById('timestampEnabled').checked = options.enabled;
      document.getElementById('timestampType').value = options.type;
      document.getElementById('timestampPosition').value = options.position;
      document.getElementById('timestampFontSize').value = options.fontSize;
      document.getElementById('timestampTextColor').value = options.textColor;
      document.getElementById('timestampTextAlign').value = options.textAlign;
      document.getElementById('timestampBold').checked = options.bold || false;
      document.getElementById('timestampItalic').checked = options.italic || false;
      document.getElementById('timestampUnderline').checked = options.underline || false;
      updateOptionsState();
    }

    // Obtenir les options actuelles
    function getCurrentOptions() {
      return {
        enabled: document.getElementById('timestampEnabled').checked,
        type: document.getElementById('timestampType').value,
        position: document.getElementById('timestampPosition').value,
        fontSize: parseInt(document.getElementById('timestampFontSize').value, 10),
        textColor: document.getElementById('timestampTextColor').value,
        textAlign: document.getElementById('timestampTextAlign').value,
        bold: document.getElementById('timestampBold').checked,
        italic: document.getElementById('timestampItalic').checked,
        underline: document.getElementById('timestampUnderline').checked
      };
    }

    // Charger le dossier de destination
    async function loadDestination() {
      const path = await ipcRenderer.invoke('get-save-path');
      document.getElementById('destinationPath').textContent = path;
      document.getElementById('destinationPath').title = path;
    }

    // Changer le dossier de destination
    async function changeDestination() {
      const newPath = await ipcRenderer.invoke('select-save-path');
      if (newPath) {
        document.getElementById('destinationPath').textContent = newPath;
        document.getElementById('destinationPath').title = newPath;
      }
    }

    // Recevoir le nom par d√©faut et l'aper√ßu
    ipcRenderer.on('default-filename', (event, defaultName) => {
      input.placeholder = defaultName;
      loadDestination();
    });

    ipcRenderer.on('preview-image', (event, base64Image) => {
      const img = new Image();
      img.onload = () => {
        originalImage = img;
        updatePreview();
      };
      img.src = `data:image/png;base64,${base64Image}`;
    });

    ipcRenderer.on('timestamp-options', (event, options) => {
      loadTimestampOptions(options);
      updatePreview();
    });

    function save() {
      const filename = input.value.trim() || input.placeholder;
      const options = getCurrentOptions();
      console.log('Saving with options:', options);
      ipcRenderer.send('filename-submit', { filename, timestampOptions: options });
    }

    function cancel() {
      ipcRenderer.send('filename-cancel');
    }

    // Enter pour sauvegarder, Escape pour annuler
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        save();
      } else if (e.key === 'Escape') {
        cancel();
      }
    });
  </script>
</body>
</html>
