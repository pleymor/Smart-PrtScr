<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart PrtScr - Save</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      overflow: hidden;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      -webkit-app-region: drag;
    }

    .container {
      background: #fff;
      padding: 15px;
      width: 100%;
      box-sizing: border-box;
      -webkit-app-region: drag;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .header h2 {
      margin: 0;
      color: #333;
      font-size: 16px;
    }

    .close-btn {
      background: #e74c3c;
      color: white;
      border: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 22px;
      padding: 0;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: #c0392b;
    }

    .content {
      -webkit-app-region: no-drag;
    }

    button, input, select, label, .preview, .input-group, .destination-row, .section-header, .buttons {
      -webkit-app-region: no-drag;
    }

    h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      outline: none;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      border-color: #555;
    }

    .format-select {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      background: white;
      cursor: pointer;
      outline: none;
      transition: border-color 0.3s;
    }

    .format-select:focus {
      border-color: #555;
    }

    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      justify-content: flex-end;
    }

    button {
      background: #555;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    button:hover {
      background: #333;
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #333;
    }

    .btn-cancel:hover {
      background: #ccc;
    }

    .btn-save {
      background: #555;
      color: white;
    }

    .btn-save:hover {
      background: #333;
    }

    .hint {
      color: #888;
      font-size: 11px;
      margin-top: 6px;
    }

    .preview {
      margin-bottom: 10px;
      text-align: center;
    }

    .preview canvas {
      max-width: 100%;
      max-height: 180px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .section {
      margin-top: 10px;
      border-top: 1px solid #ddd;
      padding-top: 8px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      padding: 5px 0;
    }

    .section-header:hover h3 {
      color: #333;
    }

    .section h3 {
      font-size: 13px;
      margin: 0;
      color: #555;
      transition: color 0.2s;
    }

    .collapse-icon {
      font-size: 10px;
      color: #888;
      transition: transform 0.3s;
    }

    .section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .section-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      max-height: 500px;
    }

    .section.collapsed .section-content {
      max-height: 0;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 8px 0;
    }

    .option-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .option-row label {
      font-size: 11px;
      color: #666;
    }

    .option-row select, .option-row input[type="number"] {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: white;
      font-size: 11px;
    }

    .option-row input[type="number"] {
      width: 60px;
    }

    .option-row.full-width {
      grid-column: 1 / -1;
    }

    .options-disabled {
      opacity: 0;
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
    }

    .style-buttons {
      display: flex;
      gap: 6px;
    }

    .style-checkbox {
      display: flex;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      padding: 3px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      background: white;
      font-size: 11px;
    }

    .style-checkbox:hover {
      background: #f0f0f0;
    }

    .style-checkbox input {
      margin: 0;
    }

    .destination-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 6px 8px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
    }

    .destination-label {
      color: #666;
      white-space: nowrap;
    }

    .destination-path {
      flex: 1;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    .destination-path:hover {
      color: #555;
    }

    .btn-folder {
      padding: 3px 6px;
      border: none;
      background: #555;
      color: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-folder:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Smart PrtScr</h2>
      <button class="close-btn" id="btnClose" title="Fermer">×</button>
    </div>
    <div class="content">
      <div class="preview">
      <canvas id="preview-canvas"></canvas>
    </div>
    <h2>Nom de la capture</h2>
    <div class="input-group">
      <input type="text" id="filename" autofocus>
      <select id="imageFormat" class="format-select">
        <option value="jpg">.jpg</option>
        <option value="png">.png</option>
      </select>
    </div>
    <p class="hint">Laissez vide pour utiliser le nom par defaut</p>

    <div class="destination-row">
      <span class="destination-label">Dossier :</span>
      <span class="destination-path" id="destinationPath" title="Cliquez pour changer">Chargement...</span>
      <button class="btn-folder" id="btnChangeFolder" title="Changer le dossier">&#128193;</button>
    </div>

    <div class="section collapsed" id="sectionTimestamp">
      <div class="section-header" id="timestampHeader">
        <h3>Options d'horodatage</h3>
        <span class="collapse-icon">&#9660;</span>
      </div>
      <div class="section-content">
        <div class="option-row full-width" style="padding: 10px 0 5px 0; flex-direction: row; align-items: center;">
          <input type="checkbox" id="timestampEnabled">
          <label for="timestampEnabled" style="cursor: pointer;"><strong>Activer l'horodatage</strong></label>
        </div>

        <div id="timestampOptionsContainer" class="options-grid">
          <div class="option-row">
            <label>Type d'affichage</label>
            <select id="timestampType">
              <option value="banner-dark">Bandeau sombre</option>
              <option value="banner-light">Bandeau clair</option>
              <option value="overlay">Par-dessus l'image</option>
            </select>
          </div>

          <div class="option-row">
            <label>Position</label>
            <select id="timestampPosition">
              <option value="bottom">Bas</option>
              <option value="top">Haut</option>
            </select>
          </div>

          <div class="option-row">
            <label>Taille du texte (px)</label>
            <input type="number" id="timestampFontSize" min="8" max="72" value="14">
          </div>

          <div class="option-row">
            <label>Couleur du texte</label>
            <select id="timestampTextColor">
              <option value="white">Blanc</option>
              <option value="black">Noir</option>
              <option value="gray">Gris</option>
              <option value="red">Rouge</option>
              <option value="green">Vert</option>
              <option value="blue">Bleu</option>
              <option value="yellow">Jaune</option>
              <option value="cyan">Cyan</option>
              <option value="magenta">Magenta</option>
            </select>
          </div>

          <div class="option-row">
            <label>Alignement du texte</label>
            <select id="timestampTextAlign">
              <option value="left">Gauche</option>
              <option value="center">Centre</option>
              <option value="right">Droite</option>
            </select>
          </div>

          <div class="option-row">
            <label>Style du texte</label>
            <div class="style-buttons">
              <label class="style-checkbox"><input type="checkbox" id="timestampBold"> <b>G</b></label>
              <label class="style-checkbox"><input type="checkbox" id="timestampItalic"> <i>I</i></label>
              <label class="style-checkbox"><input type="checkbox" id="timestampUnderline"> <u>S</u></label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button class="btn-cancel" id="btnCancel">Annuler</button>
      <button class="btn-save" id="btnSave">Enregistrer</button>
    </div>
    </div>
  </div>

  <script type="module">
    const { invoke } = window.__TAURI__.core;
    const { getCurrentWindow, LogicalSize } = window.__TAURI__.window;

    const WINDOW_WIDTH = 480;

    const input = document.getElementById('filename');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');
    let originalImage = null;
    let defaultFilename = '';

    // Ajuster la hauteur de la fenêtre au contenu avec transition
    async function adjustWindowHeight(animate = true) {
      try {
        const win = getCurrentWindow();
        const targetHeight = document.body.scrollHeight;

        if (!animate) {
          await win.setSize(new LogicalSize(WINDOW_WIDTH, targetHeight));
          return;
        }

        const currentSize = await win.innerSize();
        const startHeight = currentSize.height;
        const diff = targetHeight - startHeight;
        const duration = 200;
        const steps = 15;
        const stepTime = duration / steps;

        for (let i = 1; i <= steps; i++) {
          const progress = i / steps;
          const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
          const newHeight = Math.round(startHeight + diff * eased);
          await win.setSize(new LogicalSize(WINDOW_WIDTH, newHeight));
          await new Promise(r => setTimeout(r, stepTime));
        }
      } catch (error) {
        console.error('Error resizing window:', error);
      }
    }

    // Couleurs
    const textColors = {
      white: '#ffffff',
      black: '#000000',
      gray: '#808080',
      red: '#ff0000',
      green: '#00ff00',
      blue: '#0000ff',
      yellow: '#ffff00',
      cyan: '#00ffff',
      magenta: '#ff00ff'
    };

    // Toggle section collapse with window resize
    document.getElementById('timestampHeader').addEventListener('click', async () => {
      const section = document.getElementById('sectionTimestamp');
      section.classList.toggle('collapsed');
      // Attendre la fin de l'animation CSS puis animer le resize
      setTimeout(() => adjustWindowHeight(true), 320);
    });

    // Mettre a jour l'etat des options
    function updateOptionsState() {
      const enabled = document.getElementById('timestampEnabled').checked;
      const container = document.getElementById('timestampOptionsContainer');
      if (enabled) {
        container.classList.remove('options-disabled');
      } else {
        container.classList.add('options-disabled');
      }
    }

    // Mettre a jour l'apercu
    function updatePreview() {
      updateOptionsState();

      if (!originalImage) return;

      const options = getCurrentOptions();
      const img = originalImage;
      const fontSize = options.fontSize || 14;
      const bannerHeight = Math.max(24, fontSize + 10);

      const isOverlay = options.type === 'overlay';
      let canvasHeight = img.height;
      if (options.enabled && !isOverlay) {
        canvasHeight = img.height + bannerHeight;
      }

      canvas.width = img.width;
      canvas.height = canvasHeight;

      if (options.enabled && !isOverlay && options.position === 'top') {
        ctx.drawImage(img, 0, bannerHeight);
      } else {
        ctx.drawImage(img, 0, 0);
      }

      if (options.enabled) {
        const now = new Date();
        const timestamp = now.toLocaleString('fr-FR');
        const textColor = textColors[options.textColor] || textColors.white;
        const bannerColor = options.type === 'banner-light' ? '#f5f5f5' : '#333333';

        let fontStyle = '';
        if (options.italic) fontStyle += 'italic ';
        if (options.bold) fontStyle += 'bold ';
        fontStyle += fontSize + 'px Arial';

        ctx.font = fontStyle;
        ctx.fillStyle = textColor;

        let textX;
        if (options.textAlign === 'left') {
          ctx.textAlign = 'left';
          textX = 10;
        } else if (options.textAlign === 'right') {
          ctx.textAlign = 'right';
          textX = img.width - 10;
        } else {
          ctx.textAlign = 'center';
          textX = img.width / 2;
        }

        let bannerY, textY;
        if (!isOverlay) {
          if (options.position === 'top') {
            bannerY = 0;
            textY = bannerHeight / 2 + fontSize / 3;
          } else {
            bannerY = img.height;
            textY = img.height + bannerHeight / 2 + fontSize / 3;
          }
          ctx.fillStyle = bannerColor;
          ctx.fillRect(0, bannerY, img.width, bannerHeight);
          ctx.fillStyle = textColor;
        } else {
          if (options.position === 'top') {
            textY = 10 + fontSize;
          } else {
            textY = img.height - 10;
          }
        }

        ctx.fillText(timestamp, textX, textY);

        if (options.underline) {
          const textWidth = ctx.measureText(timestamp).width;
          let underlineX;
          if (options.textAlign === 'left') {
            underlineX = 10;
          } else if (options.textAlign === 'right') {
            underlineX = img.width - 10 - textWidth;
          } else {
            underlineX = (img.width - textWidth) / 2;
          }
          ctx.beginPath();
          ctx.strokeStyle = textColor;
          ctx.lineWidth = Math.max(1, fontSize / 10);
          ctx.moveTo(underlineX, textY + 3);
          ctx.lineTo(underlineX + textWidth, textY + 3);
          ctx.stroke();
        }
      }
    }

    // Charger les options d'horodatage (camelCase du backend Rust)
    function loadTimestampOptions(options) {
      document.getElementById('timestampEnabled').checked = options.enabled;
      document.getElementById('timestampType').value = options.type;
      document.getElementById('timestampPosition').value = options.position;
      document.getElementById('timestampFontSize').value = options.fontSize;
      document.getElementById('timestampTextColor').value = options.textColor;
      document.getElementById('timestampTextAlign').value = options.textAlign;
      document.getElementById('timestampBold').checked = options.bold || false;
      document.getElementById('timestampItalic').checked = options.italic || false;
      document.getElementById('timestampUnderline').checked = options.underline || false;
      updateOptionsState();
    }

    // Obtenir les options actuelles (camelCase pour correspondre au backend Rust)
    function getCurrentOptions() {
      return {
        enabled: document.getElementById('timestampEnabled').checked,
        type: document.getElementById('timestampType').value,
        position: document.getElementById('timestampPosition').value,
        fontSize: parseInt(document.getElementById('timestampFontSize').value, 10),
        textColor: document.getElementById('timestampTextColor').value,
        textAlign: document.getElementById('timestampTextAlign').value,
        bold: document.getElementById('timestampBold').checked,
        italic: document.getElementById('timestampItalic').checked,
        underline: document.getElementById('timestampUnderline').checked
      };
    }

    // Charger le dossier de destination
    async function loadDestination() {
      try {
        const path = await invoke('get_save_path');
        document.getElementById('destinationPath').textContent = path;
        document.getElementById('destinationPath').title = path;
      } catch (error) {
        console.error('Error loading destination:', error);
      }
    }

    // Changer le dossier de destination
    async function changeDestination() {
      try {
        const newPath = await invoke('set_save_path');
        if (newPath) {
          document.getElementById('destinationPath').textContent = newPath;
          document.getElementById('destinationPath').title = newPath;
        }
      } catch (error) {
        console.error('Error changing destination:', error);
      }
    }

    // Sauvegarder
    async function save() {
      try {
        const filename = input.value.trim() || defaultFilename;
        const options = getCurrentOptions();
        const imageFormat = document.getElementById('imageFormat').value;

        // S'assurer que fontSize est un entier valide
        if (isNaN(options.fontSize) || options.fontSize < 8) {
          options.fontSize = 14;
        }

        console.log('Saving with data:', { filename, timestampOptions: options, imageFormat });

        const savedPath = await invoke('save_screenshot', {
          data: {
            filename: filename,
            timestampOptions: options,
            imageFormat: imageFormat
          }
        });

        console.log('Saved to:', savedPath);
        await invoke('close_window', { label: 'filename-dialog' });
      } catch (error) {
        console.error('Error saving:', error);
        alert('Erreur lors de la sauvegarde: ' + error);
      }
    }

    // Annuler
    async function cancel() {
      try {
        await invoke('cancel_screenshot');
        await invoke('close_window', { label: 'filename-dialog' });
      } catch (error) {
        console.error('Error canceling:', error);
      }
    }

    // Initialisation
    async function init() {
      try {
        // Charger le nom de fichier par defaut
        defaultFilename = await invoke('get_default_filename');
        input.placeholder = defaultFilename;

        // Charger les options d'horodatage d'abord
        const timestampOpts = await invoke('get_timestamp_options');
        loadTimestampOptions(timestampOpts);

        // Charger le format d'image
        const format = await invoke('get_image_format');
        document.getElementById('imageFormat').value = format;

        // Charger la destination
        await loadDestination();

        // Charger l'apercu en dernier (et appeler updatePreview quand l'image est chargée)
        const previewBase64 = await invoke('get_preview_image');
        const img = new Image();
        img.onload = () => {
          originalImage = img;
          updatePreview();
          // Ajuster la hauteur après le chargement complet (sans animation)
          setTimeout(() => adjustWindowHeight(false), 100);
        };
        img.src = `data:image/png;base64,${previewBase64}`;
      } catch (error) {
        console.error('Error initializing:', error);
      }
    }

    // Event listeners
    console.log('Attaching event listeners...');
    document.getElementById('btnSave').addEventListener('click', () => {
      console.log('Save button clicked!');
      save();
    });
    document.getElementById('btnCancel').addEventListener('click', () => {
      console.log('Cancel button clicked!');
      cancel();
    });
    document.getElementById('btnClose').addEventListener('click', () => {
      cancel();
    });
    document.getElementById('btnChangeFolder').addEventListener('click', changeDestination);
    document.getElementById('destinationPath').addEventListener('click', changeDestination);

    // Options preview update
    ['timestampEnabled', 'timestampType', 'timestampPosition', 'timestampFontSize',
     'timestampTextColor', 'timestampTextAlign', 'timestampBold', 'timestampItalic',
     'timestampUnderline'].forEach(id => {
      document.getElementById(id).addEventListener('change', updatePreview);
      if (id === 'timestampFontSize') {
        document.getElementById(id).addEventListener('input', updatePreview);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        save();
      } else if (e.key === 'Escape') {
        cancel();
      }
    });

    // Start
    init();
  </script>
</body>
</html>
